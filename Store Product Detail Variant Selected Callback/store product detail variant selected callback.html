<!-- 

  begin store product detail variant selected callback
  
  License       : < https://bit.ly/3F8sn8W >
  
  Version       : 0.1.0
  
  SS Versions   : 7.1, 7.0
  
  v7.1
  Fluid
  Engine
  Compatible    : Not Applicable
  
  Dependencies  : twcsl < https://bit.ly/3JSggyu >
  
  By            : Thomas Creedon < http://www.tomsWeb.consulting/ >
  
  -->
  
  <script>
  
    if ( window.twc == undefined ) window.twc = { };
    
    twc.spdvsc = {
    
      /*
      
        following is an example line. copy the example line below and paste
        after the example line. remove '// ' at beginning of pasted line
        
        your callback must accept three parameters :
        
          sku ( string )
          
          selectedVariant ( JavaScript object, the selected variant data )
          
          $element ( JQuery object, the product variants element )
          
        */
        
      // callback : [enter function name here replacing square brackets]
      
      };
      
    </script>
    
  <!-- do not change anything below, there be the borg here -->
  
  <script>
  
    $( ( ) => {
    
      // bail if no mutation observer available
      
      if ( ! ( 'MutationObserver' in window ) ) return;
      
      const debugFlag = false;
      
      const initialize = ( ) => {
      
        if ( ! twcsl.page.store.detail.is ) return; // bail if not detail
        
        const options = twc.spdvsc;
        
        if ( options.callback == undefined ) return; // bail if no callback
        
        const callback = options.callback;
        
        const observer = new MutationObserver ( function ( mutations ) {
        
          if ( debugFlag )
          
            console.log ( 'mutations : ', mutations );
            
          $.each ( mutations, function ( ) {
          
            if ( this.oldValue != null ) return true; // continue
            
            if ( debugFlag ) {
            
              console.log ( 'this : ', this );
              
              console.log ( 'this.target : ', this.target );
              
              }
              
            const $element = $( this.target );
            
            let selectedVariant = $element.attr ( 'data-selected-variant' );
            
            if ( selectedVariant == undefined ) return true; // continue
            
            selectedVariant = JSON.parse ( selectedVariant );
            
            if ( debugFlag )
            
              console.log ( 'selectedVariant : ', selectedVariant );
              
            const sku = selectedVariant.sku;
            
            callback ( sku, selectedVariant, $element );
            
            } );
            
          } );
          
        // start listening for changes in elements
        
        $( '.product-variants' ).each ( function ( ) {
        
          observer.observe ( this, {
          
            attributes : true,
            
            attributeFilter : [ 'data-selected-variant' ],
            
            attributeOldValue : true,
            
            } );
            
          } );
          
        };
        
      switch ( true ) {
      
        case twcsl.ss.is71 :
        
          $( initialize );
          
          break;
          
        case twcsl.ss.is70 :
        
          Squarespace.onInitialize ( Y, initialize );
          
          break;
          
        }
        
      } );
      
    </script>
    
  <!-- end store product detail variant selected callback -->
