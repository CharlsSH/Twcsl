<script>

  /*
  
    begin form block fields from search parameters
    
    License       : < https://tinyurl.com/s872fb68 >
    
    Version       : 0.1.0-development.5
    
    SS Versions   : 7.1, 7.0
    
    v7.1
    Fluid
    Engine
    Compatible    : Yes
    
    Dependencies  : form block wrapper observe changes
                    < https://tinyurl.com/ub8akb85 >
    
    Note          : this effect is not active in SS Preview to test it use
                    private browsing < https://bit.ly/3f6lhq2 >
                    
                    this effect does not work with fields checkbox, radio, or
                    survey
    
    By            : Thomas Creedon < http://www.tomsWeb.consulting/ >
    
    no user serviceable parts below
    
    */
    
  var twcFbffsp = $reactFormContents => {
  
    const codeKey = 'twc-fbffsp';
    
    const consoleMessages = false;
    
    let selector = `.section .title:contains('${ codeKey }')`;
    
    const $trigger = $( selector, $reactFormContents );
    
    if ( ! $trigger.length ) return; // bail if no trigger
    
    const selectorFormItem = '.form-item';
    
    selector = '.field-list';
    
    const $fieldList = $( selector, $reactFormContents );
    
    $trigger
    
      .parents ( selectorFormItem )
      
      .remove ( );
      
    selector = `.description:contains(\'${ codeKey } : \')`;
      
    $( selector, $fieldList )
    
      .each ( function ( ) {
      
        const $this = $( this );
        
        let text = $this.text ( );
        
        const m = text.match ( /twc-fbffsp : (.+)[\n]?/ );
        
        if ( m == null ) return true; // continue
        
        $formItem = $this
        
          .parents ( selectorFormItem );
          
        const searchParameterKeyLabelMap = m [ 1 ]
        
          .split ( ', ' )
          
          .map ( s => s.split ( '=' ) );
          
        const skipFields = [
        
          'checkbox',
          
          'radio',
          
          'survey',
          
          ];
        
        text = text
        
          .replace ( m [ 0 ], '' )
          
          .trim ( );
          
        if ( text ) // set description or remove
        
          $this.text ( text );
          
          else
          
            $this.remove ( );
            
        const isSkipField = [
        
          ... $formItem
          
            .get ( 0 )
            
            .classList
            
          ]
        
          .some ( c => skipFields.indexOf ( c ) >= 0 );
        
        if ( isSkipField ) return true; // continue
        
        const searchParams =
        
          new URLSearchParams ( location.search );
          
        for ( const [ key, caption ] of searchParameterKeyLabelMap ) {
        
          const b = ! searchParams.has ( key );
          
          if ( b ) continue; // continue if no key
          
          const inputChangeTrigger = ( node, value = '' ) => {
          
            /*
            
              based on code by Dan G < https://tinyurl.com/4hes79u8 > and
              others
              
              */
              
            const inputTypes = [
            
              window.HTMLInputElement,
              
              window.HTMLSelectElement,
              
              window.HTMLTextAreaElement,
              
              ];
              
            /*
            
              only process the change on elements we know have a value setter in their
              constructor
              
              */
              
            const isInputType = inputTypes
            
              .indexOf (
              
                node.__proto__.constructor
                
                )
                
              >
              
              -1;
              
            if ( ! isInputType ) return; // bail if not input type
            
            const event = new Event ( 'input', { bubbles : true } );
            
            const setValue = Object
            
              .getOwnPropertyDescriptor ( node.__proto__, 'value' )
              
              .set;
              
            setValue.call ( node, value );
            
            node.dispatchEvent ( event );
            
            };
            
          const selector = 'input, select, textarea';
          
          let input;
          
          let value = searchParams.get ( key );
          
          if ( caption == undefined )
          
            input = $formItem;
            
            else {
            
              const selectorCaption = `.caption:contains('${ caption }')`;
              
              input = $( selectorCaption, $formItem )
              
                .parents ( '.field' );
                
              if ( ! input.length ) return true; // continue
              
              }
              
          input = $( selector, input )
          
            .get ( 0 );
            
          value = decodeURIComponent ( value );
          
          inputChangeTrigger ( input, value );
          
          }
          
        } );
        
    };
    
  </script>
