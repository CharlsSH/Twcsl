<!--

  begin store price change
  
  Version         : 0.3d2
  
  SS Versions     : 7.1, 7.0
  
  v7.0 Templates  : Brine ( Aria, Blend, Burke, Cacao, Clay, Fairfield, Feed,
                    Foster, Greenwich, Hatch, Heights, Hunter, Hyde, Impact,
                    Jaunt, Juke, Keene, Kin, Lincoln, Maple, Margot, Marta,
                    Mentor, Mercer, Miller, Mojave, Moksha, Motto, Nueva, Pedro,
                    Pursuit, Rally, Rover, Royce, Sofia, Sonora, Stella, Thorne,
                    Vow, Wav, West )
                    
                    Five
                    
                    Montauk ( Julia, Kent, Om )
                    
                    your template is not listed? then it is not currently
                    supported
  
  Dependancies    : jQuery
                    
                    twcsl
  
  Notes           : the code is comprised of several tags all of which must be
                    present for the effect to work
                    
                    the code adds a data-twc-spc-mo attribute with value of
                    false on the element with class product-price. by changing
                    the attribute value to true you will cause a mutation which
                    will cause the search replace text to run. the attribute
                    value will be set to false after the search replace text run
  
  By              : Thomas Creedon < http://www.tomsWeb.consulting/ >
  
  -->
  
  <script>
  
    const searchReplaceText = {
    
      /*
      
        the format of each line is a search text and a replacement text or
        replacement text function
        
        if the text has single quotes in them then put a backslash before
        the single quotes. example: it's becomes it\'s
        
        search text can be a string or a regular expression, backslashes need to
        be escaped in regular expressions
        
        replacement text can use regular expression grouping syntax when the
        search text is a regular expression
        
        replacement text functions need to accept a node parameter and return
        replacement text or false. your function needs to be defined before this
        code runs. functions are run only in response to variant menus changes
        
        following is are example lines. copy an example line below and paste
        after the example lines. remove '// ' at beginning of pasted line.
        repeat for as many times as needed
        
        */
        
      // search text and replacment text example line follows
      
      // '[enter search text here between single quotes]' : '[enter replacement text here between single quotes]',
      
      // search text and replacment text function example line follows
      
      // '[enter search text here between single quotes]' : [enter replacement text function name here],
      
      };
      
    </script>
    
  <!-- do not change anything below, there be the borg here -->
  
  <style>
  
    .product-price {
    
      visibility : hidden;
      
      }
      
    </style>
    
  <script>
  
    $( ( ) => {
    
      const keys = Object.keys ( searchReplaceText );
      
      const changeText = ( node, useFunctions = false ) => {
      
        const walker = document.createTreeWalker ( node, NodeFilter.SHOW_TEXT );
        
        while ( walker.nextNode ( ) ) {
        
          const node = walker.currentNode;
          
          let t = node.data;
          
          $.each ( keys, function ( i, key ) {
          
            const m = key.match ( /\/(.+)\/(.*)/ );
            
            let r = searchReplaceText [ key ];
            
            let s = key;
            
            if ( m !== null ) s = new RegExp ( m [ 1 ], m [ 2 ] );
            
            if ( typeof r == 'function' ) {
            
              // continue if functions not used
              
              if ( ! useFunctions ) return true;
              
              r = r ( node );
              
              if ( ! r ) return true; // bail if r is false
              
              }
              
            t = t.replace ( s, r );
            
            } );
            
          node.data = t;
          
          }
          
        }
        
      const $productPrices = $( '.product-price' ).each ( function ( ) {
      
        changeText ( this );
        
        $( this ).css ( 'visibility', 'visible' );
        
        } );
        
      if ( ! twcsl.storePage.isDetail ) return; // bail if not product detail
      
      // bail if no mutation observer available
      
      if ( ! ( 'MutationObserver' in window ) ) return;
      
      const attribute = 'data-twc-spc-mo';
      
      const observer = new MutationObserver ( mutations => {
      
        const firstMutation = mutations [ 0 ];
        
        const target = firstMutation.target;
        
        // previous change was forced
        
        if ( firstMutation.attributeName == attribute )
        
          if ( $( firstMutation.target ).attr ( attribute ) == 'true' )
          
            $( firstMutation.target ).attr ( attribute, 'false' );
            
            else if ( firstMutation.oldValue == 'true' )
            
              return;
              
        observer.disconnect ( );
        
        changeText ( target, true );
        
        observer.observe ( productPrice [ 0 ], {
        
          attributeFilter : [ attribute ],
          
          attributeOldValue : true,
          
          childList : true
          
          } );
          
        } );
        
      const productPrice = $productPrices
      
        .first ( )
        
        .attr ( attribute, 'false' );
        
      // start listening for changes in product price
      
      observer.observe ( productPrice [ 0 ], {
      
        attributeFilter : [ attribute ],
        
        attributeOldValue : true,
        
        childList : true
        
        } );
        
      } );
      
    </script>
    
  <!-- end store price change -->
