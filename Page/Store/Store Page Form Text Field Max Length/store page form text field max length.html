<!--

  begin store page form text field max length
  
  License         : < https://tinyurl.com/s872fb68 >
  
  Version         : 0.2.0
  
  SS Versions     : 7.1, 7.0
  
  v7.1
  Fluid
  Engine
  Compatible      : Not Applicable
  
  v7.0 Templates  : Brine ( Aria, Blend, Burke, Cacao, Clay, Fairfield, Feed,
                    Foster, Greenwich, Hatch, Heights, Hunter, Hyde, Impact,
                    Jaunt, Juke, Keene, Kin, Lincoln, Maple, Margot, Marta,
                    Mentor, Mercer, Miller, Mojave, Moksha, Motto, Nueva, Pedro,
                    Pursuit, Rally, Rover, Royce, Sofia, Sonora, Stella, Thorne,
                    Vow, Wav, West )
                    
                    your template is not listed? then it is not currently
                    supported
  
  Dependencies    : twcsl
                    
                    modal lightbox observe changes
  
  Note            : this effect is not active in Squarespace Preview to test it
                    use private browsing < https://tinyurl.com/ynessvsf >
  
  By              : Thomas Creedon < http://www.tomsWeb.consulting/ >
  
  no user serviceable parts below
  
  -->
  
  <style>
  
    html:not( .squarespace-damask ) .collection-type-products .sqs-async-form-content .form-wrapper .field-list .field .field-element[ placeholder*="ftfml" ] {
    
      visibility : hidden;
      
      }
      
    </style>
    
  <script>
  
    ( ( ) => {
    
      const version = '0.2.0';
      
      const s = `Store Page Form Text Field Max Length v${ version }, ` +
      
        'License < https://tinyurl.com/s872fb68 >, ' +
        
        'Tom\'s Web Consulting < http://www.tomsWeb.consulting >';
        
      console.log ( s );
      
      // initialize twc global if needed
      
      if ( window.twc == undefined ) window.twc = { };
      
      twc.spftfml = {
      
        ids : undefined
        
        };
        
      } ) ( );
      
    $( ( ) => {
    
      const codeKey = 'twc-spftfml';
      
      const detail = ( ) => {
      
        const callback = function ( ) {
        
          const data = twc.spftfml;
          
          const $this = $( this );
          
          const context = Static
          
            .SQUARESPACE_CONTEXT;
            
          data.ids = [
          
            context
            
              .itemId
              
            ];
            
          const variants = context
          
            .product
            
            .variants;
            
          if ( variants === undefined ) return; // bail if no variants
          
          if ( variants.length == 1 )
          
            data
            
              .ids
              
              .push ( variants [ 0 ].sku )
              
            else {
            
              let dataSelectedVariant = $this
              
                .parent ( )
                
                .siblings ( '.product-variants' )
              
                .attr ( 'data-selected-variant' );
                
              // bail if no variant selected
              
              if ( dataSelectedVariant === undefined ) return;
              
              const sku = JSON
              
                .parse ( dataSelectedVariant )
                
                .sku;
                
              data
              
                .ids
                
                .push ( sku );
                
              }
              
          };
          
        const selector = [
        
          '.ProductItem', // simple layout
          
          '.pdp-layout' // full, half, wrap layout
          
          ]
          
          .map ( l => `${ l }:not( .sold-out ) ` +
          
            '.sqs-add-to-cart-button-wrapper ' +
            
            '.sqs-add-to-cart-button.use-form' )
            
          .join ( ', ' );
          
        $( selector ).click ( callback );
        
        };
        
      const list = ( ) => {
      
        const clickCallback = function ( ) {
        
          const data = twc.spftfml;
          
          const $this = $( this );
          
          data.ids = [
          
            $this
            
              .attr ( 'data-item-id' )
              
            ];
            
          let b = $this
          
            .attr ( `data-${ codeKey }-no-sku` )
            
            !==
            
            undefined;
            
          if ( b ) return; // bail if attribute
          
          const $productVariants = $this
          
            .prop ( '$productVariants' );
            
          if ( $productVariants === undefined )
          
            data
            
              .ids
              
              .push (
              
                $this
                
                  .attr ( `data-${ codeKey }-sku` )
                  
                );
                
            else {
            
              let dataSelectedVariant = $productVariants
              
                .attr ( 'data-selected-variant' );
                
              // bail if no variant selected
              
              if ( dataSelectedVariant === undefined ) return;
              
              const sku = JSON
              
                .parse ( dataSelectedVariant )
                
                .sku;
                
              data
              
                .ids
                
                .push ( sku );
                
              }
              
          };
          
        const eachCallback = function ( ) {
        
          const $this = $( this );
          
          const dataProductType = $this
          
            .attr ( 'data-product-type' );
            
          const b = [
          
            '2' // digital
            
            ]
            
            .includes ( dataProductType );
            
          const $gridItem = $this
          
              .parents ( '.grid-item' );
              
          if ( b ) {
          
            $gridItem
            
              .attr ( `data-${ codeKey }-no-sku`, '' );
              
            return true; // continue
            
            }
            
          const callback = ( data ) => {
          
            const sku = data
            
              .item
              
              .variants
              
              [ 0 ]
              
              .sku;
              
            $gridItem
            
              .attr ( `data-${ codeKey }-sku`, sku );
              
            };
            
          const $productVariants = $this
          
            .parent ( )
            
            .siblings ( '.product-variants' );
            
          if ( $productVariants.length ) {
          
            $gridItem
            
              .prop ( '$productVariants', $productVariants );
              
            return true; // continue
            
            }
            
          const url = $this
          
            .parents ( '.plp-grid-add-to-cart' )
            
            .prev ( )
            
            .attr ( 'href' )
            
            +
            
            '?format=json';
            
          $.getJSON ( url, callback );
          
          };
          
        const selector = '.products.collection-content-wrapper ' +
        
          '.grid-item:not( .sold-out ) .sqs-add-to-cart-button-wrapper ' +
          
          '.sqs-add-to-cart-button.use-form';
        
        $( selector )
        
          .each ( eachCallback )
          
          .parents ( '.grid-item' )
          
          .click ( clickCallback );
          
        };
        
      switch ( true ) {
      
        case twcsl.page.store.detail.is :
        
          detail ( );
          
          break;
          
        case twcsl.page.store.list.is :
        
          list ( );
          
          break;
          
        }
        
      } );
      
    var twcSpftfml = ( node ) => {
    
      const b = node
      
        .classList
        
        .contains ( 'sqs-product-quick-view-lightbox' );
        
      const codeKey = 'twc-spftfml';
      
      const formCallback = ( ) => {
      
        const callback = ( element ) => {
        
          const attribute = 'placeholder';
          
          const re = /^ftfml\s*:\s*{([^}]+)}\s*/;
          
          let text = element
          
            .getAttribute ( attribute );
            
          let m = text.match ( re );
          
          // begin clean up placeholder attribute value
          
            text = text
            
              .replace ( m [ 0 ], '' )
              
              .trim ( );
              
            if ( text ) // set/show placeholder or remove
            
              element
              
                .setAttribute ( attribute, text );
                
              else
              
                element.removeAttribute ( attribute );
                
            // end clean up placeholder attribute value
            
          let maxLength = m [ 1 ]
          
            .trim ( );
            
          if ( isNaN ( maxLength ) ) {
          
            const callback = ( key ) => {
            
              const b = ! twc
              
                .spftfml
                
                .ids
                
                .includes ( key );
                
              if ( b ) return; // bail if no key
              
              maxLength = idMaxlengthMap [ key ];
              
              };
              
            const json = '{' +
            
              maxLength
              
                .replace ( /[\s]/g, '' )
                
                .split ( ',' )
                
                .map ( s => s.replace ( /([^:]+)/, '"$1"' ) )
                
                .join ( ',' ) +
                
              '}';
              
            const key = 'default';
            
            const idMaxlengthMap = JSON.parse ( json );
            
            maxLength = '';
            
            if ( key in idMaxlengthMap )
            
              maxLength = idMaxlengthMap [ key ];
              
            Object
            
              .keys ( idMaxlengthMap )
              
              .forEach ( callback );
              
            }
            
          if ( maxLength )
          
            element
            
              .setAttribute ( 'maxlength', maxLength );
              
          };
          
        const selector = '.form-wrapper input[ placeholder*="ftfml" ]';
        
        node
        
          .querySelectorAll ( selector )
          
          .forEach ( callback );
          
        };
        
      const quickViewCallback = ( ) => {
      
        const callback = ( mutations ) => {
        
          const callback = ( mutation ) => {
          
            const b = ! mutation.addedNodes.length;
            
            if ( b ) return; // continue
            
            const callback = function ( ) {
            
              const data = twc.spftfml;
              
              const itemId = this
              
                .getAttribute ( 'data-item-id' );
                
              const selector = `.grid-item[ data-item-id="${ itemId }" ]`;
              
              data.ids = [ itemId ];
              
              let sku = document
              
                .querySelector ( selector )
              
                .getAttribute ( `data-${ codeKey }-sku` );
                
              if ( sku !== null ) {
              
                data.ids.push ( sku );
                
                return; // bail if no sku
              
                }
                
              let noSku = document
              
                .querySelector ( selector )
              
                .getAttribute ( `data-${ codeKey }-no-sku` );
                
              let b = noSku !== null && ! noSku;
              
              if ( b ) return; // bail if no sku
              
              let variant = this
              
                .closest ( '.ProductItem-details-checkout' )
                
                .querySelector ( '.product-variants' )
                
                .getAttribute ( 'data-selected-variant' );
                
              if ( variant === null ) return; // bail if no selected variants
              
              variant = JSON.parse ( variant );
              
              data
              
                .ids
                
                .push ( variant.sku );
                
              }
              
            const selector = '.ProductItem:not( .sold-out ) ' +
            
              '.sqs-add-to-cart-button-wrapper ' +
              
              '.sqs-add-to-cart-button.use-form';
              
            const element = mutation
            
              .addedNodes
              
              [ 0 ];
              
            b = ! element
            
              .classList
              
              .contains ( '.ProductItem' );
              
            if ( b ) return; // bail if not product item
              
            element
            
              .querySelector ( selector )
              
              .addEventListener ( 'click', callback );
              
            };
            
          mutations.forEach ( callback );
          
          };
          
        const config = {
        
          childList : true
          
          };
          
        const selector = '.sqs-product-quick-view-content';
        
        const element = node
        
          .querySelector ( selector );
          
        const observer = new MutationObserver ( callback );
        
        // start listening for changes in body
        
        observer.observe ( element, config );
        
        };
        
      if ( b )
      
        quickViewCallback ( );
        
        else
        
          formCallback ( );
          
      };
      
    </script>
    
  <!-- end store page form text field max length -->
