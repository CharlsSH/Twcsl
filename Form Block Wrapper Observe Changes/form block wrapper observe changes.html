<!--

  begin form block wrapper observe changes
  
  License       : < https://bit.ly/3F8sn8W >
  
  Version       : 0.1.0
  
  SS Versions   : 7.1, 7.0
  
  v7.1
  Fluid
  Engine
  Compatible    : Yes
  
  Dependencies  : jQuery
  
  Note          : the code is comprised of a style and script tag. both are
                  needed for the full effect to work
                  
                  this code is a base for other effects. on its own it doesn't
                  do much. this code is not the end all be all of mutation
                  observers. it may not cover your needs
                  
                  this effect is not active in SS Preview to test it use private
                  browsing < https://bit.ly/3f6lhq2 >
  
  By            : Thomas Creedon < http://www.tomsWeb.consulting/ >
  
  no user serviceable parts below
  
  -->
  
  <style>
  
    html:not( .squarespace-damask ) #siteWrapper {
    
      --twc-sqs-block-form-visibility : hidden;
      --twc-fbwoc : hidden;
      
      }
      
    html:not( .squarespace-damask ) .sqs-block-form {
    
      visibility : var( --twc-sqs-block-form-visibility );
      
      }
      
    html:not( .squarespace-damask ) .sqs-block-form.twc-fbwoc {
    
      visibility : var( --twc-fbwoc );
      
      }
      
    html:not( .squarespace-damask ) .sqs-block-form.twc-fbwoc .section.twc-fbwoc {
    
      display : none;
      
      }
      
    </style>
    
  <script>
  
    $( ( ) => {
    
      const codeKey = 'twc-fbwoc';
      
      const consoleMessages = false;
      
      const selectorKey = '.sqs-block-form';
      
      if ( window.twc == undefined ) window.twc = { };
      
      if ( twc.data == undefined ) twc.data = { };
      
      if ( twc.data.hideShow == undefined ) twc.data.hideShow = { };
      
      if ( twc.data.hideShow [ selectorKey ] == undefined )
      
        twc
        
          .data
          
          .hideShow
          
          [ selectorKey ]
          
          =
          
          [ ];
          
      twc
      
        .data
        
        .hideShow
        
        [ selectorKey ]
        
        .push ( `--${ codeKey }` );
        
      ( ( ) => {
      
        // bail if no mutation observer available
        
        if ( ! ( 'MutationObserver' in window ) ) return;
        
        // if ( window.frameElement !== null ) return; // bail if in preview
        
        const callback = mutations => {
        
          $.each ( mutations, function ( ) {
          
            const nodesAdded =
            
              Boolean ( this.addedNodes.length );
              
            const nodesRemoved =
            
              Boolean ( this.removedNodes.length );
              
            let $node;
            
            switch ( true ) {
            
              case nodesAdded :
              
                $node = $( this.addedNodes [ 0 ] );
                
                break;
                
              case nodesRemoved :
              
                $node = $( this.removedNodes [ 0 ] );
                
                break;
                
              }
              
            const isInnerWrapper = $node.hasClass ( 'form-inner-wrapper' );
            
            const isReactContents = $node.hasClass ( 'react-form-contents' );
            
            const b = isInnerWrapper || isReactContents;
            
            if ( ! b ) return true; // continue
            
            const selector = `.title:contains('${ codeKey }') ~ ` +
            
              '.description:contains(\'callbacks\')';
              
            const $description = $( selector, $node );
            
            if ( ! $description.length ) return; // bail if no description
            
            let c;
            
            let callbacks = {
            
              added : undefined,
              
              removed : undefined
              
              };
              
            try {
            
              c = $description
              
                .text ( )
                
                .match ( /"callbacks"\s*:\s*(.+)/s )
                
                [ 1 ];
                
              c = JSON.parse ( c );
              
              c.added = window [ c.added ];
              
              c.removed = window [ c.removed ];
              
              } catch ( error ) {
              
                const s = `${ codeKey } callback parse error : `;
                
                if ( consoleMessages )
                
                  console.error ( s, error );
                  
                return;
                
                }
                
            $description
            
              .parents ( '.section' )
              
              .addClass ( `${ codeKey }` );
              
            Object.assign ( callbacks, c );
            
            let callback;
            
            switch ( true ) {
            
              case nodesAdded :
              
                callback = callbacks.added;
                
                break;
                
              case nodesRemoved :
              
                callback = callbacks.removed;
                
                break;
                
              }
              
            // bail if no callback
            
            if ( callback == undefined ) {
            
              const error = `${ codeKey } no callback :
              
                added ${ callbacks.added }
                
                removed ${ callbacks.removed }
                
                `;
                
              if ( consoleMessages )
              
                console.warn ( error );
                
              return;
              
              }
              
            callback ( $node );
            
            } );
            
          }; // end callback
          
        const observer = new MutationObserver ( callback );
        
        const selector = '.sqs-block-form .title:contains(\'' +
        
          `${ codeKey }') ~ .description:contains('callbacks')`;
        
        // begin listening for changes in specified elements
        
        const $elements = $( selector )
        
          .each ( function ( ) {
          
            const $this = $( this );
            
            const $formWrapper = $this
            
              .parents ( '.form-wrapper' );
              
            $formWrapper
            
              .parents ( '.sqs-block-form' )
              
              .addClass ( `${ codeKey } ` );
              
            const element = $formWrapper
            
              .get ( 0 );
              
            observer.observe ( element, {
            
              childList : true
              
              } );
              
            } );
            
        } ) ( );
        
      $( '#siteWrapper' )
      
        .css ( `--${ codeKey }`, 'visible' );
        
      twc
      
        .data
        
        .hideShow
        
        [ selectorKey ]
        
        .pop ( `--${ codeKey }` );
        
      const l = twc
      
        .data
        
        .hideShow
        
        [ selectorKey ]
        
        .length;
        
      if ( ! l )
      
        $( '#siteWrapper' )
        
          .css ( '--twc-sqs-block-form-visibility', 'unset' );
          
      } );
    
    </script>
    
  <!-- end form block observe changes -->
